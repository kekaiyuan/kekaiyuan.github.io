<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Java Spring 04—— AOP 的详细讲解 &mdash; 菜鸟日记</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://kekaiyuan.github.io//2021/07/31/04-aop/"><link rel="alternate" type="application/atom+xml" title="菜鸟日记" href="https://kekaiyuan.github.io//feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/favicon.ico"><meta property="og:title" content="Java Spring 04—— AOP 的详细讲解"><meta name="keywords" content="Java, Spring"><meta name="og:keywords" content="Java, Spring"><meta name="description" content="Java Spring 04—— AOP 的详细讲解"><meta name="og:description" content="Java Spring 04—— AOP 的详细讲解"><meta property="og:url" content="https://kekaiyuan.github.io//2021/07/31/04-aop/"><meta property="og:site_name" content="菜鸟日记"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-07-31"> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://kekaiyuan.github.io//" title="菜鸟日记"><span class="octicon octicon-mark-github"></span> 菜鸟日记</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://kekaiyuan.github.io//" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://kekaiyuan.github.io//categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://kekaiyuan.github.io//archives/" class=" site-header-nav-item" target="" title="归档">归档</a> <a href="https://kekaiyuan.github.io//wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://kekaiyuan.github.io//links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://kekaiyuan.github.io//about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Java Spring 04—"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Java Spring 04—— AOP 的详细讲解</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/07/31 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://kekaiyuan.github.io//categories/#Spring" title="Spring">Spring</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 21869 字，约 63 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/images/qrcode.jpg" alt="闷骚的程序员" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>Java Spring 04—— AOP 的详细讲解</p><h1 id="序言">序言</h1><p>要理解 Spring AOP，必须先理解 <a href="https://kekaiyuan.github.io//2021/06/11/proxy/#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">动态代理</a>。</p><h1 id="为什么要引入-aop">为什么要引入 AOP？</h1><p>先通过以下代码的优化升级来感受<strong>动态代理</strong>和 <strong>AOP</strong> 的提出目的。</p><hr /><p>现在实现一个计算器类，能够实现两个数字的加、减、乘、除。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCalculator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">sub</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">mul</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">div</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">/</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>测试</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MyCalculator</span> <span class="n">myCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCalculator</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">myCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">myCalculator</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">myCalculator</span><span class="o">.</span><span class="na">mul</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">));</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">myCalculator</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">));</span>
</code></pre></div></div><p>结果</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">12</span>
<span class="mi">0</span>
<span class="mi">36</span>
<span class="mi">1</span>
</code></pre></div></div><hr /><p>输出过于简单，增加一些信息</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCalculator</span> <span class="kd">implements</span> <span class="nc">Calculator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"add 方法开始执行，参数为："</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"add 方法完成，结果为："</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">sub</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"sub 方法开始执行，参数为："</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"sub 方法完成，结果为："</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">mul</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"mul 方法开始执行，参数为："</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"mul 方法完成，结果为："</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">div</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"div 方法开始执行，参数为："</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"div 方法完成，结果为："</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div><p>测试</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MyCalculator</span> <span class="n">myCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCalculator</span><span class="o">();</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">mul</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add 方法开始执行，参数为：6,6
add 方法完成，结果为：12

sub 方法开始执行，参数为：6,6
add 方法完成，结果为：0

mult 方法开始执行，参数为：6,6
add 方法完成，结果为：36

div 方法开始执行，参数为：6,6
add 方法完成，结果为：1

</code></pre></div></div><hr /><p>四个方法中有大量的重复代码，尝试提取出来，写一个工具类</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil01</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">objects</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法开始执行，参数是："</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">objects</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">...</span> <span class="n">objects</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法执行结束，结果是："</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">objects</span><span class="o">)</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">logException</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法出现异常："</span><span class="o">);</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">end</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法结束"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>修改 MyCalculator 类</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCalculator</span> <span class="kd">implements</span> <span class="nc">Calculator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span> <span class="o">{</span>
        <span class="nc">Method</span> <span class="n">add</span> <span class="o">=</span> <span class="nc">MyCalculator</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"add"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">add</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="n">add</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">sub</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span> <span class="o">{</span>
        <span class="nc">Method</span> <span class="n">sub</span> <span class="o">=</span> <span class="nc">MyCalculator</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"sub"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">sub</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="n">sub</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">mul</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span> <span class="o">{</span>
        <span class="nc">Method</span> <span class="n">mul</span> <span class="o">=</span> <span class="nc">MyCalculator</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"mul"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">mul</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="n">mul</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">div</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span> <span class="o">{</span>
        <span class="nc">Method</span> <span class="n">div</span> <span class="o">=</span> <span class="nc">MyCalculator</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"div"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">div</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="n">j</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">j</span><span class="o">;</span>
        <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="n">div</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div><p>测试</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MyCalculator</span> <span class="n">myCalculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCalculator</span><span class="o">();</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">mul</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">myCalculator</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add 方法开始执行，参数是：[6, 6]
add 方法执行结束，结果是：[12]

sub 方法开始执行，参数是：[6, 6]
sub 方法执行结束，结果是：[0]

mul 方法开始执行，参数是：[6, 6]
mul 方法执行结束，结果是：[36]

div 方法开始执行，参数是：[6, 6]
div 方法执行结束，结果是：[1]

</code></pre></div></div><p>如果是面向对象编程的话，这样的代码已经很棒了。</p><p>但仔细阅读代码，有没有一种切入的感觉？<br /> —— LogUtil01 类的方法像切片一样，切入到了 MyCalculator 类的方法中。</p><p>那我能不能把 LogUtil01 类的方法<strong>动态性地切入到任何一个类的任何一个方法中</strong>？</p><p>何为动态性？<br /> 上文就是静态的，MyCalculator 类调用 LogUtil 类是写入程序中的，是一开始就定好的，执行多少遍，结果都一样。<br /> 而如果是动态的，那么程序将在执行过程中，将 LogUtil 类的方法切入到某个类的方法中（程序运行前并未写入该类中）。</p><p>这就是 <a href="https://kekaiyuan.github.io//2021/06/11/proxy/#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">动态代理</a>。<br /> 不理解动态代理的同学请戳上方链接，下文直接贴代码。</p><hr /><p>将 MyCalculator 类还原为最简单的版本</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCalculator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">sub</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">mul</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">div</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">/</span> <span class="n">j</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h3 id="cglib-的动态代理">Cglib 的动态代理</h3><p>Cglib 是一个额外的 Jar 包，通过该 Jar 包实现动态代理比较简单，<strong>不需要实现接口</strong>。</p><p>其 Maven 依赖为</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>cglib<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>cglib<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>3.3.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CglibProxy</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="nc">Class</span> <span class="n">clz</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Enhancer</span> <span class="n">enhancer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Enhancer</span><span class="o">();</span>
        <span class="n">enhancer</span><span class="o">.</span><span class="na">setSuperclass</span><span class="o">(</span><span class="n">clz</span><span class="o">);</span>

        <span class="n">enhancer</span><span class="o">.</span><span class="na">setCallback</span><span class="o">(</span><span class="k">new</span> <span class="nc">MethodInterceptor</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">objects</span><span class="o">,</span> <span class="nc">MethodProxy</span> <span class="n">methodProxy</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">objects</span><span class="o">);</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">methodProxy</span><span class="o">.</span><span class="na">invokeSuper</span><span class="o">(</span><span class="n">o</span><span class="o">,</span><span class="n">objects</span><span class="o">);</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">logException</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">throwable</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">end</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result1</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="nc">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="n">enhancer</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>测试</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MyCalculator</span> <span class="n">proxy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MyCalculator</span><span class="o">)</span> <span class="nc">CglibProxy</span><span class="o">.</span><span class="na">getProxy</span><span class="o">(</span><span class="nc">MyCalculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">proxy</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">proxy</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">proxy</span><span class="o">.</span><span class="na">mul</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">proxy</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add 方法开始执行，参数是：[6, 6]
add 方法执行结束，结果是：[12]
add 方法结束

sub 方法开始执行，参数是：[6, 6]
sub 方法执行结束，结果是：[0]
sub 方法结束

mul 方法开始执行，参数是：[6, 6]
mul 方法执行结束，结果是：[36]
mul 方法结束

div 方法开始执行，参数是：[6, 0]
div 方法出现异常：java.lang.ArithmeticException: / by zero
	...(此处省略一万行异常信息)
div 方法结束
</code></pre></div></div><p>LogUtil 类添加了异常处理，然后调用时进行了 <code class="language-plaintext highlighter-rouge">6/0</code> 的操作，成功地处理了除 0 异常。</p><h3 id="jdk-自带的动态代理">JDK 自带的动态代理</h3><p>JDK 本身就能够实现动态代理，只不过需要<strong>实现接口</strong>。</p><p>定义接口</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Calculator</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">sub</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">mul</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">div</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">NoSuchMethodException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>将 MyCalculator 类实现该接口</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCalculator</span> <span class="kd">implements</span> <span class="nc">Calculator</span> <span class="o">{</span>
	<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><p>实现动态代理</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamicProxy</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">getProxy</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="n">object</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">();</span>

        <span class="nc">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">logException</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="nc">LogUtil01</span><span class="o">.</span><span class="na">end</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="nc">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">interfaces</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">proxy</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>测试</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add 方法开始执行，参数是：[6, 6]
add 方法执行结束，结果是：[12]
add 方法结束

sub 方法开始执行，参数是：[6, 6]
sub 方法执行结束，结果是：[0]
sub 方法结束

mul 方法开始执行，参数是：[6, 6]
mul 方法执行结束，结果是：[36]
mul 方法结束

div 方法开始执行，参数是：[6, 0]
div 方法出现异常：java.lang.reflect.InvocationTargetException
	...(此处省略一万行异常信息)
div 方法结束
</code></pre></div></div><h2 id="性能差异">性能差异</h2><p>使用 Cglib 和 JDK 实现的动态代理有性能上的差异吗？</p><p>在以前，是有差异的，低版本的 JDK 的动态代理性能比不过同期的 Cglib 的动态代理。</p><p>但是 Cglib 已经很久没更新了（笔者在 2021.08.02 找到的 Cglib 是 2019.08 的 3.3.0 版）。</p><p>而 JDK 一直在更新，也有优化动态代理。</p><p>所以高版本的 JDK 的动态代理的性能是不弱于 Cglib 的。</p><h1 id="什么是-aop">什么是 AOP？</h1><p>经过前面的几个案例，我们已经理解了动态代理的作用和好处。</p><p>但是以上的方式依然不够好：</p><ol><li>需要手写动态代理的源码，比较麻烦。</li><li>实现了动态代理后，被代理类的所有方法都会被代理，无法只代理类中的<strong>一部分</strong>方法。</li></ol><ul><li>AOP<br /> Aspect Oriented Programming<br /> <strong>面向切面编程</strong></li><li>OOP<br /> Object Oriented Programming<br /> <strong>面向对象编程</strong></li></ul><p>AOP 是基于 OOP 提出的一种新的编程思想。</p><p>现在把执行某个类的某个方法看作一段<strong>轨道</strong>。<br /> 一个程序，会有多个类，每个类又会有多个方法，总共就有<strong>许多轨道</strong>。<br /> 通过 AOP ，我们可以把这些方法的执行过程<strong>切开</strong>，然后在切开的位置装入额外的功能代码。<br /> 这就是面向切面编程——将某段代码<strong>动态切入</strong>到指定方法的指定位置中去。</p><p>上文的动态代理就属于 AOP 的范畴。<br /> 把方法的执行过程切分：</p><ul><li>在方法开始运行前，切入了 <code class="language-plaintext highlighter-rouge">LogUtil01.start()</code> 方法</li><li>在方法捕获异常时，切入了 <code class="language-plaintext highlighter-rouge">LogUtil01.logException()</code> 方法</li><li>在方法得到计算结果后，切入了 <code class="language-plaintext highlighter-rouge">LogUtil01.stop()</code> 方法</li><li>在方法结束后，切入了 <code class="language-plaintext highlighter-rouge">LogUtil01.end()</code> 方法</li></ul><h5 id="aop的核心概念及术语">AOP的核心概念及术语</h5><ul><li>切面（Aspect）: 指关注点模块化，这个关注点可能会横切多个对象。事务管理是企业级Java应用中有关横切关注点的例子。 在Spring AOP中，切面可以使用通用类基于模式的方式（schema-based approach）或者在普通类中以<code class="language-plaintext highlighter-rouge">@Aspect</code>注解（@AspectJ 注解方式）来实现。</li><li>连接点（Join point）: 在程序执行过程中某个特定的点，例如某个方法调用的时间点或者处理异常的时间点。在Spring AOP中，一个连接点总是代表一个方法的执行。</li><li>通知（Advice）: 在切面的某个特定的连接点上执行的动作。通知有多种类型，包括“around”, “before” and “after”等等。通知的类型将在后面的章节进行讨论。 许多AOP框架，包括Spring在内，都是以拦截器做通知模型的，并维护着一个以连接点为中心的拦截器链。</li><li>切点（Pointcut）: 匹配连接点的断言。通知和切点表达式相关联，并在满足这个切点的连接点上运行（例如，当执行某个特定名称的方法时）。切点表达式如何和连接点匹配是AOP的核心：Spring默认使用AspectJ切点语义。</li><li>引入（Introduction）: 声明额外的方法或者某个类型的字段。Spring允许引入新的接口（以及一个对应的实现）到任何被通知的对象上。例如，可以使用引入来使bean实现 <code class="language-plaintext highlighter-rouge">IsModified</code>接口， 以便简化缓存机制（在AspectJ社区，引入也被称为内部类型声明（inter））。</li><li>目标对象（Target object）: 被一个或者多个切面所通知的对象。也被称作被通知（advised）对象。既然Spring AOP是通过运行时代理实现的，那么这个对象永远是一个被代理（proxied）的对象。</li><li>AOP代理（AOP proxy）:AOP框架创建的对象，用来实现切面契约（aspect contract）（包括通知方法执行等功能）。在Spring中，AOP代理可以是JDK动态代理或CGLIB代理。</li><li>织入（Weaving）: 把切面连接到其它的应用程序类型或者对象上，并创建一个被被通知的对象的过程。这个过程可以在编译时（例如使用AspectJ编译器）、类加载时或运行时中完成。 Spring和其他纯Java AOP框架一样，是在运行时完成织入的。</li></ul><h5 id="aop的通知类型">AOP的通知类型</h5><ul><li>前置通知（Before advice）: 在连接点之前运行但无法阻止执行流程进入连接点的通知（除非它引发异常）。</li><li>后置返回通知（After returning advice）:在连接点正常完成后执行的通知（例如，当方法没有抛出任何异常并正常返回时）。</li><li>后置异常通知（After throwing advice）: 在方法抛出异常退出时执行的通知。</li><li>后置通知（总会执行）（After (finally) advice）: 当连接点退出的时候执行的通知（无论是正常返回还是异常退出）。</li><li>环绕通知（Around Advice）:环绕连接点的通知，例如方法调用。这是最强大的一种通知类型，。环绕通知可以在方法调用前后完成自定义的行为。它可以选择是否继续执行连接点或直接返回自定义的返回值又或抛出异常将执行结束。</li></ul><h5 id="aop的应用场景">AOP的应用场景</h5><ul><li>日志管理</li><li>权限认证</li><li>安全检查</li><li>事务控制</li></ul><h1 id="spring-aop-的简单使用">Spring AOP 的简单使用</h1><h2 id="导入-jar-包">导入 Jar 包</h2><p>通过 Maven 添加以下依赖</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/cglib/cglib --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>cglib<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>cglib<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>3.3.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>1.9.5<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- https://mvnrepository.com/artifact/aopalliance/aopalliance --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>aopalliance<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>aopalliance<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-aspects --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>5.2.3.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><h2 id="编写切面类-logutil02">编写切面类 LogUtil02</h2><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil02</span> <span class="o">{</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法开始执行，参数是："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterReturning</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法执行完成，结果是："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterThrowing</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">logException</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法出现异常："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@After</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">end</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法结束。\n"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>简单解析该代码：</p><p><code class="language-plaintext highlighter-rouge">@Component</code><br /> 将该类注册到 IOC 容器中</p><p><code class="language-plaintext highlighter-rouge">@Aspect</code><br /> 指明该类为切面类</p><p>通知类型。<br /> 表明切入到方法中的哪个<strong>位置</strong>。</p><ul><li><code class="language-plaintext highlighter-rouge">@Before</code> 前置通知<br /> 在目标方法之前运行</li><li><code class="language-plaintext highlighter-rouge">@After</code> 后置通知<br /> 在目标方法之后运行</li><li><code class="language-plaintext highlighter-rouge">@AfterReturning</code> 返回通知<br /> 在目标方法正常返回之后</li><li><code class="language-plaintext highlighter-rouge">@AfterThrowing</code> 异常通知<br /> 在目标方法抛出异常后开始运行</li><li><code class="language-plaintext highlighter-rouge">@Around</code> 环绕通知<br /> 环绕</li></ul><p>切入点表达式 <code class="language-plaintext highlighter-rouge">execution(访问修饰符 返回值类型 方法全称)</code><br /> 表明切入到什么<strong>方法</strong>中。<br /></p><p>像<code class="language-plaintext highlighter-rouge">execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))</code><br /> 表示切入 <code class="language-plaintext highlighter-rouge">com.kky.service.MyCalculator</code> 类的 <code class="language-plaintext highlighter-rouge">public Integer add(Integer i, Integer j)</code> 方法中。</p><h2 id="编写配置">编写配置</h2><p>请先将前文中的</p><ul><li>LogUtil 类添加 <code class="language-plaintext highlighter-rouge">@Component</code> 注解</li><li>MyCalculator 类添加 <code class="language-plaintext highlighter-rouge">@Service</code> 注解</li></ul><p>以将它们加载到 IOC 容器中。</p><p>然后修改 application.xml 文件</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/aop
       http://www.springframework.org/schema/aop/spring-aop.xsd
"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!--开启自动扫描--&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.kky"</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>
    <span class="c">&lt;!--开启 aop 的注解功能--&gt;</span>
    <span class="nt">&lt;aop:aspectj-autoproxy&gt;&lt;/aop:aspectj-autoproxy&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><h2 id="测试">测试</h2><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ClassPathXmlApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">Calculator</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Calculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">bean</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 方法开始执行，参数是：
 方法执行完成，结果是：
 方法结束。
</code></pre></div></div><h2 id="动态代理的类型">动态代理的类型</h2><p>前文介绍了两种动态代理：</p><ol><li>使用 JDK 实现</li><li>使用 Cglib 实现</li></ol><p>两者最大的区别在于是否需要<strong>接口</strong>。</p><p>而 Spring AOP 底层原理也是这两种动态代理。</p><p>那么到底使用哪种呢？</p><p>Spring AOP 会自动选择：</p><ul><li>有接口，使用 <strong>JDK</strong> 实现</li><li>无接口，使用 <strong>Cglib</strong> 实现</li></ul><p>看上去很方便对吧，无论有没有接口，我们使用 Spring AOP 的方法都是一样的，不需要关心细节。</p><p>唯一有一点要<strong>注意</strong>：<br /> <strong>当使用接口时，从 IOC 容器中取对象时必须使用接口类型！</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyCalculator</span> <span class="kd">implements</span> <span class="nc">Calculator</span> <span class="o">{</span>
	<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><p>可以看到，此时的 MyCalculator 类继承于 Calculator <strong>接口</strong>，Spring AOP 会自动使用 <strong>JDK</strong> 来实现动态代理。</p><p>此时调用动态代理必须使用如下方式：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="nc">Calculator</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Calculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div></div><p>使用的是 <code class="language-plaintext highlighter-rouge">Calculator.class</code></p><p>如果是这样</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="nc">MyCalculator</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">MyCalculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div></div><p>则会报错</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">beans</span><span class="o">.</span><span class="na">factory</span><span class="o">.</span><span class="na">NoSuchBeanDefinitionException</span><span class="o">:</span> <span class="nc">No</span> <span class="n">qualifying</span> <span class="n">bean</span> <span class="n">of</span> <span class="n">type</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="err">'</span> <span class="n">available</span>
<span class="o">...</span>
</code></pre></div></div><p>找不到该类，说明 IOC 容器注册该 bean 对象时使用的是<strong>接口的类型</strong>。</p><h1 id="详解-spring-aop">详解 Spring AOP</h1><p>上文只是简单地介绍了 Spring AOP 如何使用。<br /> 这里对其做出详解。</p><h2 id="切入点表达式">切入点表达式</h2><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execution</span><span class="o">(</span><span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Integer</span><span class="o">,</span><span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>这是最精准的匹配方式，规定了修饰符、返回值、完全限定名、方法名、形参。<br /> 这种匹配方式至多匹配到一个方法，是最准确的。</p><p>但是在实际中，我们并不需要这么准确，因为<strong>一对一</strong>意味着代码量的<strong>增加</strong>。<br /> 我们更希望实现<strong>一对多</strong>，所以有了<strong>通配符</strong>。</p><p>通配符有两种： <code class="language-plaintext highlighter-rouge">*</code> 和 <code class="language-plaintext highlighter-rouge">..</code></p><h3 id="通配符">通配符</h3><h4 id="-号">* 号</h4><ol><li>匹配一个或者多个字符<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">a</span><span class="o">*(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>可匹配所有以 a 开头的方法，包括 ab, ac, abc, add…<br /></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.*(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>匹配所有方法。<br /> 对于类名和包名同样有效。</p></li><li>匹配任意类型的参数<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="o">*))</span>
</code></pre></div></div><p>第二个参数的类型将不做限制</p></li><li>匹配路径<br /> 当使用 * 匹配路径时，根据使用方法不同，其效果也不同<ul><li>匹配多层路径<ul><li>只有 *<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="o">*(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>将匹配所有类的所有方法。</p></li><li>* + 方法名<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="o">*.</span><span class="na">add</span><span class="o">(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>匹配所有类的 add 方法</p></li></ul></li><li>匹配单层路径<br /> 除了以上两种使用方法，* 只能匹配单层路径，例如<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="o">*.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="o">*))</span>
</code></pre></div></div><p>只能匹配最外层路径下的 MyCalculator 类，而 <code class="language-plaintext highlighter-rouge">com.kky.service.MyCalculator</code> 类是匹配不到的。</p></li></ul></li><li>匹配返回值<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="o">*</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>可匹配所有的返回值</p></li><li>* 不能用于匹配修饰符。<br /> 如果有需要，请直接<strong>省略</strong>修饰符。<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">execution</span><span class="o">(</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>此时将匹配所有的修饰符</p></li></ol><h4 id="-两个点">.. （两个点）</h4><ol><li>可匹配参数，其数量和类型不限。<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(..))</span>
</code></pre></div></div><p>此时参数列表没有限制</p></li><li>匹配多层路径<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">..</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">add</span><span class="o">(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>此时可以匹配到 <code class="language-plaintext highlighter-rouge">com.kky.service.MyCalculator</code></p></li></ol><h4 id="总结">总结</h4><p>通配符的功能很强大，请根据需要，合理地制定匹配规则。</p><p>当需要为<strong>所有类的所有方法</strong>增加动态代理时，可以使用以下<strong>最偷懒的方式</strong>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execution</span><span class="o">(</span> <span class="o">*</span> <span class="o">*(..))</span>
</code></pre></div></div><h3 id="逻辑运算---">逻辑运算 &amp;&amp; || !</h3><p>表达式除了使用通配符扩大匹配范围，更可以使用逻辑运算。<br /> 其运算和 Java 中的逻辑运算一样。</p><ul><li><code class="language-plaintext highlighter-rouge">&amp;&amp;</code><br /> 同时满足两个表达式<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.</span><span class="na">a</span><span class="o">*(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="n">execution</span><span class="o">(</span> <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">com</span><span class="o">.</span><span class="na">kky</span><span class="o">.</span><span class="na">service</span><span class="o">.</span><span class="na">MyCalculator</span><span class="o">.*</span><span class="n">d</span><span class="o">(</span> <span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">))</span>
</code></pre></div></div><p>匹配名称以 a 开头，以 d 结尾的方法</p></li><li><code class="language-plaintext highlighter-rouge">||</code><br /> 满足一个表达式即可</li><li><code class="language-plaintext highlighter-rouge">!</code><br /> 除了这个表达式外的地方都可以切入</li></ul><h2 id="抽取表达式">抽取表达式</h2><p>可以看到，表达式是有重复性的，往往一个切面类中所有通知的表达式都是同一个。<br /> 此时可以对表达式进行抽取，简化代码。</p><ol><li>声明一个空方法并添加 <code class="language-plaintext highlighter-rouge">@PointCut</code> 注解</li><li>用该方法替换通知中的表达式</li></ol><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">```</span><span class="n">java</span>
<span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil02</span> <span class="o">{</span>

    <span class="nd">@PointCut</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myPointCut</span><span class="o">(){}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法开始执行，参数是："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterReturning</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法执行完成，结果是："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterThrowing</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">logException</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法出现异常："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@After</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">end</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法结束。\n"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="通知的执行顺序sdfasdfqwer">通知的执行顺序sdfasdfqwer</h2><h6 id="2通知方法的执行顺序">2、通知方法的执行顺序</h6><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>在之前的代码中大家一直对通知的执行顺序有疑问，其实执行的结果并没有错，大家需要注意：

1、正常执行：@Before---&gt;@After---&gt;@AfterReturning

2、异常执行：@Before---&gt;@After---&gt;@AfterThrowing
</code></pre></div></div><h2 id="如何定义通知方法的参数">如何定义通知方法的参数</h2><p>通知方法在定义时对于访问修饰符、返回值都<strong>没有</strong>明确要求。</p><ul><li>无论是 <code class="language-plaintext highlighter-rouge">public</code> 还是 <code class="language-plaintext highlighter-rouge">private</code> ，通知方法都能够被调用。</li><li>无论写不写返回值都不影响返回值的功能，一般不写。</li></ul><p>但是通知方法对于<strong>参数</strong>的要求特别严格，需要<strong>严格</strong>地遵照规范。</p><h3 id="joinpoint">JoinPoint</h3><p>JoinPoint 可直接写入通知方法的参数列表，其包含了有关于被切入的方法的相关信息。</p><p>常用于获取方法名称和参数。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil</span> <span class="o">{</span>

    <span class="nd">@PointCut</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myPointCut</span><span class="o">(){}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">+</span><span class="s">" 方法开始执行，参数是："</span><span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@AfterReturning</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span>
                <span class="s">" 方法执行完成，结果是："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@AfterThrowing</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">logException</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法出现异常："</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@After</span><span class="o">(</span><span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">end</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法结束。"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div><p>测试</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ClassPathXmlApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">Calculator</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Calculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">bean</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add 方法开始执行，参数是：[6, 6]
add 方法结束。
add 方法执行完成，结果是：
</code></pre></div></div><p>成功获取到了<strong>方法名</strong>和<strong>参数</strong>，但是没有返回值。</p><h3 id="配置注解的参数">配置注解的参数</h3><p>五种注解可以配置的参数如下</p><table><thead><tr><th style="text-align: center"><code class="language-plaintext highlighter-rouge">@Before()</code></th><th style="text-align: center"><code class="language-plaintext highlighter-rouge">@AfterReturning</code></th><th style="text-align: center"><code class="language-plaintext highlighter-rouge">@AfterThrowing</code></th><th style="text-align: center"><code class="language-plaintext highlighter-rouge">@After</code></th><th style="text-align: center"><code class="language-plaintext highlighter-rouge">@Round</code></th></tr></thead><tbody><tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">value</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">value</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">value</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">value</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">value</code></td></tr><tr><td style="text-align: center"><code class="language-plaintext highlighter-rouge">argName</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">argName</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">argName</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">argName</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">argName</code></td></tr><tr><td style="text-align: center"> </td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">pointcut</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">pointcut</code></td><td style="text-align: center"> </td><td style="text-align: center"> </td></tr><tr><td style="text-align: center"> </td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">returning</code></td><td style="text-align: center"><code class="language-plaintext highlighter-rouge">throwing</code></td><td style="text-align: center"> </td><td style="text-align: center"> </td></tr></tbody></table><h4 id="value">value</h4><p><code class="language-plaintext highlighter-rouge">value</code> 就是切入点表达式。<br /> 当注解中只有切入点表达式时 <code class="language-plaintext highlighter-rouge">value</code> 可以<strong>省略</strong>。<br /> 当注解中有其他参数时需要<strong>显式</strong>地写出 <code class="language-plaintext highlighter-rouge">value</code> 以<strong>区分</strong>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil</span> <span class="o">{</span>

    <span class="nd">@PointCut</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myPointCut</span><span class="o">(){}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"myPointCut()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">){</span>
		<span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">joinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">+</span><span class="s">" 方法开始执行，参数是："</span><span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="o">...</span>

<span class="o">}</span>
</code></pre></div></div><h4 id="argname">argName</h4><p><code class="language-plaintext highlighter-rouge">argName</code> 用于配置被切入方法的<strong>参数</strong>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil</span> <span class="o">{</span>

    <span class="nd">@PointCut</span><span class="o">(</span><span class="s">"execution( public Integer com.kky.service.MyCalculator.add( Integer, Integer))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myPointCut</span><span class="o">(){}</span>

    <span class="nd">@Before</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"myPointCut() &amp;&amp; args(i,j)"</span><span class="o">,</span> <span class="n">argNames</span> <span class="o">=</span> <span class="s">"i,j"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">i</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">j</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" 方法开始执行，参数是："</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">j</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span>

<span class="o">}</span>
</code></pre></div></div><ol><li>首先要在 <code class="language-plaintext highlighter-rouge">value</code> 里配置 <code class="language-plaintext highlighter-rouge">args(i,j)</code><br /><ol><li>强制限定匹配的方法只有两个参数。<br /> 因为 Spring 需要通过限制方法参数来确定匹配的方法是哪一个。</li><li>给参数起别名，为了之后的调用。</li></ol></li><li>在注解中添加 <code class="language-plaintext highlighter-rouge">argNames</code> 参数。</li><li>在通知方法中写入参数。</li></ol><p>注意：<br /> 这三个地方必须<strong>一致</strong>！</p><p>测试：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ClassPathXmlApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">Calculator</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Calculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">bean</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 方法开始执行，参数是：6,6
...
</code></pre></div></div><h4 id="pointcut">pointcut</h4><p><code class="language-plaintext highlighter-rouge">pointcut</code> 的功能和 <code class="language-plaintext highlighter-rouge">value</code> 的功能是一样的，都用于配置切入点表达式，一般不用。</p><h4 id="returning">returning</h4><p>用于获取方法的返回值</p><p>在 <code class="language-plaintext highlighter-rouge">@AfterReturning</code> 注解中添加 <code class="language-plaintext highlighter-rouge">returning</code> 参数，并写入方法形参。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil02</span> <span class="o">{</span>

    <span class="o">...</span>
	
    <span class="nd">@AfterReturning</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"execution( public Integer com.kky.service.MyCalculator.*(Integer,Integer))"</span><span class="o">,</span> <span class="n">returning</span> <span class="o">=</span> <span class="s">"result"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法执行完成，结果是："</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="o">...</span>

<span class="o">}</span>
</code></pre></div></div><p>重新测试结果</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
add 方法执行完成，结果是：12
</code></pre></div></div><h4 id="throwing">throwing</h4><p>获取异常信息</p><p>在 <code class="language-plaintext highlighter-rouge">@AfterThrowing</code> 注解中添加 <code class="language-plaintext highlighter-rouge">throwing</code> 参数，并写入方法形参。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil02</span> <span class="o">{</span>

    <span class="o">...</span>

	<span class="nd">@AfterThrowing</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"execution( public Integer com.kky.service.MyCalculator.*(Integer,Integer))"</span><span class="o">,</span> <span class="n">throwing</span> <span class="o">=</span> <span class="s">"e"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">logException</span><span class="o">(</span><span class="nc">JoinPoint</span> <span class="n">joinPoint</span><span class="o">,</span> <span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">joinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 方法出现异常："</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>

    <span class="o">...</span>

<span class="o">}</span>
</code></pre></div></div><p>测试除 0 异常</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ClassPathXmlApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">Calculator</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Calculator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">bean</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="n">div</span> <span class="n">方法出现异常</span><span class="err">：</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ArithmeticException</span><span class="o">:</span> <span class="o">/</span> <span class="n">by</span> <span class="n">zero</span>

<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ArithmeticException</span><span class="o">:</span> <span class="o">/</span> <span class="n">by</span> <span class="n">zero</span>
<span class="o">...(</span><span class="n">此处省略异常详情</span><span class="o">)</span>
</code></pre></div></div><h6 id="6环绕通知的使用">6、环绕通知的使用</h6><p>LogUtil.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.aspectj.lang.JoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="nd">@Aspect</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogUtil</span> <span class="o">{</span>
    <span class="nd">@Pointcut</span><span class="o">(</span><span class="s">"execution( public int com.kky.services.MyCalculator.*(int,int))"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myPoint</span><span class="o">(){}</span>
    
    <span class="cm">/**
     * 环绕通知是spring中功能最强大的通知
     * @param proceedingJoinPoint
     * @return
     */</span>
    <span class="nd">@Around</span><span class="o">(</span><span class="s">"myPoint()"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">myAround</span><span class="o">(</span><span class="nc">ProceedingJoinPoint</span> <span class="n">proceedingJoinPoint</span><span class="o">){</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span> <span class="o">=</span> <span class="n">proceedingJoinPoint</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">proceedingJoinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">proceed</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"环绕前置通知:"</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">"方法开始，参数是"</span><span class="o">+</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
            <span class="c1">//利用反射调用目标方法，就是method.invoke()</span>
            <span class="n">proceed</span> <span class="o">=</span> <span class="n">proceedingJoinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"环绕返回通知:"</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">"方法返回，返回值是"</span><span class="o">+</span><span class="n">proceed</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"环绕异常通知"</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">"方法出现异常，异常信息是："</span><span class="o">+</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"环绕后置通知"</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">"方法结束"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">proceed</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>总结：环绕通知的执行顺序是优于普通通知的，具体的执行顺序如下：</p><p>环绕前置–&gt;普通前置–&gt;目标方法执行–&gt;环绕正常结束/出现异常–&gt;环绕后置–&gt;普通后置–&gt;普通返回或者异常。</p><p>但是需要注意的是，如果出现了异常，那么环绕通知会处理或者捕获异常，普通异常通知是接收不到的，因此最好的方式是在环绕异常通知中向外抛出异常。</p><h1 id="多切面类的运行顺序">多切面类的运行顺序</h1><p>如果要执行多个切面类，顺序是怎样的？</p><p>默认情况下，根据<strong>类名</strong>的<strong>字典序</strong> <strong>升序</strong>执行。</p><p>假如现有切面类 AAspect 和 BAspect<br /> 此时先执行 AAspect ，再执行 BAspect</p><p>具体的执行流程是这样的</p><pre><code class="language-mermaid">graph TD;
A1["AAspect @Before"] --&gt; B1("BAspect @Before")
B1 --&gt; Z((核心逻辑))
Z --&gt; B2("BAspect @AfterReturning&lt;br&gt;或 BAspect @AfterThrowing")
B2 --&gt; B3("BAspect @After")
B3 --&gt; A2["AAspect @AfterReturning&lt;br&gt;或 AAspect @AfterThrowing"]
A2 --&gt; A3["AAspect @After"]
</code></pre><p>根据名称进行排序肯定不是我们想要的方式，所以可以使用 <code class="language-plaintext highlighter-rouge">@Order</code> 注解改变顺序。<br /> 先执行数值小的切面类。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="nd">@Order</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AAspect</span><span class="o">{</span>
	<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aspect</span>
<span class="nd">@Component</span>
<span class="nd">@Order</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BAspect</span><span class="o">{</span>
	<span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><p>此时就是先执行 BAspect，再执行 AAspect</p><p>如果需要添加环绕通知呢，具体的执行顺序又会是什么顺序呢？</p><p>因为环绕通知在进行添加的时候，是在切面层引入的，所以在哪个切面添加环绕通知，那么就会在哪个切面执行。</p><h3 id="3基于配置的aop配置">3、基于配置的AOP配置</h3><p>之前我们讲解了基于注解的AOP配置方式，下面我们开始讲一下基于xml的配置方式，虽然在现在的企业级开发中使用注解的方式比较多，但是你不能不会，因此需要简单的进行配置，注解配置快速简单，配置的方式共呢个完善。</p><p>1、将所有的注解都进行删除</p><p>2、添加配置文件</p><p>aop.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/aop
       https://www.springframework.org/schema/aop/spring-aop.xsd
"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.mashibing"</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>
    <span class="nt">&lt;aop:aspectj-autoproxy&gt;&lt;/aop:aspectj-autoproxy&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"logUtil"</span> <span class="na">class=</span><span class="s">"com.mashibing.util.LogUtil2"</span><span class="nt">&gt;&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"securityAspect"</span> <span class="na">class=</span><span class="s">"com.mashibing.util.SecurityAspect"</span><span class="nt">&gt;&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"myCalculator"</span> <span class="na">class=</span><span class="s">"com.kky.services.MyCalculator"</span><span class="nt">&gt;&lt;/bean&gt;</span>
    <span class="nt">&lt;aop:config&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"globalPoint"</span> <span class="na">expression=</span><span class="s">"execution(public int com.kky.services.MyCalculator.*(int,int))"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:aspect</span> <span class="na">ref=</span><span class="s">"logUtil"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"mypoint"</span> <span class="na">expression=</span><span class="s">"execution(public int com.kky.services.MyCalculator.*(int,int))"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;aop:before</span> <span class="na">method=</span><span class="s">"start"</span> <span class="na">pointcut-ref=</span><span class="s">"mypoint"</span><span class="nt">&gt;&lt;/aop:before&gt;</span>
            <span class="nt">&lt;aop:after</span> <span class="na">method=</span><span class="s">"end"</span> <span class="na">pointcut-ref=</span><span class="s">"mypoint"</span><span class="nt">&gt;&lt;/aop:after&gt;</span>
            <span class="nt">&lt;aop:after-returning</span> <span class="na">method=</span><span class="s">"stop"</span> <span class="na">pointcut-ref=</span><span class="s">"mypoint"</span> <span class="na">returning=</span><span class="s">"result"</span><span class="nt">&gt;&lt;/aop:after-returning&gt;</span>
            <span class="nt">&lt;aop:after-throwing</span> <span class="na">method=</span><span class="s">"logException"</span> <span class="na">pointcut-ref=</span><span class="s">"mypoint"</span> <span class="na">throwing=</span><span class="s">"exception"</span><span class="nt">&gt;&lt;/aop:after-throwing&gt;</span>
            <span class="nt">&lt;aop:around</span> <span class="na">method=</span><span class="s">"myAround"</span> <span class="na">pointcut-ref=</span><span class="s">"mypoint"</span><span class="nt">&gt;&lt;/aop:around&gt;</span>
        <span class="nt">&lt;/aop:aspect&gt;</span>
        <span class="nt">&lt;aop:aspect</span> <span class="na">ref=</span><span class="s">"securityAspect"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;aop:before</span> <span class="na">method=</span><span class="s">"start"</span> <span class="na">pointcut-ref=</span><span class="s">"globalPoint"</span><span class="nt">&gt;&lt;/aop:before&gt;</span>
            <span class="nt">&lt;aop:after</span> <span class="na">method=</span><span class="s">"end"</span> <span class="na">pointcut-ref=</span><span class="s">"globalPoint"</span><span class="nt">&gt;&lt;/aop:after&gt;</span>
            <span class="nt">&lt;aop:after-returning</span> <span class="na">method=</span><span class="s">"stop"</span> <span class="na">pointcut-ref=</span><span class="s">"globalPoint"</span> <span class="na">returning=</span><span class="s">"result"</span><span class="nt">&gt;&lt;/aop:after-returning&gt;</span>
            <span class="nt">&lt;aop:after-throwing</span> <span class="na">method=</span><span class="s">"logException"</span> <span class="na">pointcut-ref=</span><span class="s">"globalPoint"</span> <span class="na">throwing=</span><span class="s">"exception"</span><span class="nt">&gt;&lt;/aop:after-throwing&gt;</span>
            <span class="nt">&lt;aop:around</span> <span class="na">method=</span><span class="s">"myAround"</span> <span class="na">pointcut-ref=</span><span class="s">"mypoint"</span><span class="nt">&gt;&lt;/aop:around&gt;</span>
        <span class="nt">&lt;/aop:aspect&gt;</span>
    <span class="nt">&lt;/aop:config&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>Spring AOP 一共有五种通知，可以分为两类：</p><ul><li>普通通知<ul><li>前置通知</li><li>后置返回通知</li><li>后置异常通知</li><li>后置通知</li></ul></li><li>环绕通知</li></ul><p>在这里先讲解普通通知，再讲解环绕通知。</p><h1 id="源码链接">源码链接</h1><p>该文章源码链接 <a href="url">Github</a></p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://kekaiyuan.github.io/" target="_blank">Kaiyuan Ke</a></li><li>本文链接：<a href="https://kekaiyuan.github.io//2021/07/31/04-aop/" target="_blank">https://kekaiyuan.github.io//2021/07/31/04-aop/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/07/31/04-aop/', clientID: '', clientSecret: '', repo: '', owner: '', admin: [''], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:350px" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:16px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://kekaiyuan.github.io//assets/search_data.json?v=1646200239', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="Kaiyuan Ke">Kaiyuan Ke</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/kekaiyuan/kekaiyuan.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://kekaiyuan.github.io//" title="首页" target="">首页</a></li><li> <a href="https://kekaiyuan.github.io//categories/" title="分类" target="">分类</a></li><li> <a href="https://kekaiyuan.github.io//archives/" title="归档" target="">归档</a></li><li> <a href="https://kekaiyuan.github.io//wiki/" title="维基" target="">维基</a></li><li> <a href="https://kekaiyuan.github.io//links/" title="链接" target="">链接</a></li><li> <a href="https://kekaiyuan.github.io//about/" title="关于" target="">关于</a></li><li><a href="https://kekaiyuan.github.io//feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script> {\% if page.mermaid \%} <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/7.1.0/mermaid.min.js"></script> <script> var config = { startOnLoad:true, flowchart:{ useMaxWidth:false, htmlLabels:true } }; mermaid.initialize(config); $(function(){ var elements = document.getElementsByClassName("language-mermaid"); for (var i = elements.length; i--;) { element = elements[i]; var graphDefinition = element.innerText; if (graphDefinition) { var svg = mermaid.render('ha_mermaid_' + i, graphDefinition, function(svg){}); if (svg) { var svgElement = document.createElement('div'); preNode = element.parentNode; svgElement.innerHTML = svg; svgElement.setAttribute('class', 'mermaid'); svgElement.setAttribute('data-processed', 'true'); preNode.parentNode.replaceChild(svgElement, preNode); } } } }); </script> {\% endif \%}<div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
