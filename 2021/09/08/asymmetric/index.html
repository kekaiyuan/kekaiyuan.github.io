<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>非对称加密 &mdash; 菜鸟日记</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://kekaiyuan.github.io//2021/09/08/asymmetric/"><link rel="alternate" type="application/atom+xml" title="菜鸟日记" href="https://kekaiyuan.github.io//feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/favicon.ico"><meta property="og:title" content="非对称加密"><meta name="keywords" content="keyword1, keyword2"><meta name="og:keywords" content="keyword1, keyword2"><meta name="description" content="非对称加密"><meta name="og:description" content="非对称加密"><meta property="og:url" content="https://kekaiyuan.github.io//2021/09/08/asymmetric/"><meta property="og:site_name" content="菜鸟日记"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-09-08"> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://kekaiyuan.github.io//" title="菜鸟日记"><span class="octicon octicon-mark-github"></span> 菜鸟日记</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://kekaiyuan.github.io//" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://kekaiyuan.github.io//categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://kekaiyuan.github.io//archives/" class=" site-header-nav-item" target="" title="归档">归档</a> <a href="https://kekaiyuan.github.io//wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://kekaiyuan.github.io//links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://kekaiyuan.github.io//about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="非对称加密"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">非对称加密</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/09/08 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://kekaiyuan.github.io//categories/#cate1" title="cate1">cate1</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://kekaiyuan.github.io//categories/#cate2" title="cate2">cate2</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2491 字，约 8 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/images/qrcode.jpg" alt="闷骚的程序员" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="非对称加密">非对称加密</h1><pre><code class="language-sequence">title: 非对称加密流程
participant 客户端 as A
participant 服务器 as B
Note over A: 生成密钥对 A
A-&gt;B: 发送公钥 A
Note over B: 生成密钥对 B
B-&gt;A: 发送公钥 B
Note over A: 使用\n公钥 B 加密\n数据
A-&gt;B: 发送密文
Note over B: 使用\n私钥 B 解密\n数据
Note over B: 使用\n公钥 A 加密\n数据
B-&gt;A: 发送密文
Note over A: 使用\n私钥 A 解密\n数据
</code></pre><p>非对称加密的安全性极高。</p><ul><li>在网络中传递的只有公钥，并没有传递私钥。</li><li>第三方即使获取了公钥，也是无法解开密文的，密文必须使用私钥解密。</li></ul><p>但是非对称加密的效率极低，比对称加密慢<strong>数千倍</strong>。</p><p>所以往往<strong>混合</strong>使用</p><ul><li>使用非对称加密传递对称加密的密钥</li><li>使用对称加密传递一般数据</li></ul><h2 id="中间人攻击">中间人攻击</h2><p>非对称加密看上去很美，但它真的就是完美无缺的了吗？</p><p>非对称加密依然可以被<strong>破解</strong>。</p><pre><code class="language-sequence">title: 中间人攻击
participant 客户端 as A
participant 中间人 as C
participant 服务器 as B
participant B
Note over A: 生成密钥对 A
A-&gt;B: 发送公钥 A
Note over B: 生成密钥对 B
B-&gt;C: 发送公钥 B
Note over C: 截取公钥 B
Note over C: 生成密钥对 C
C-&gt;A: 发送公钥 C
Note over A: 使用\n公钥 C 加密\n数据
A-&gt;C: 发送密文
Note over C: 截取密文
Note over C: 使用\n私钥 C 解密\n数据
Note over C: 修改明文
Note over C: 使用\n公钥 B 加密\n修改后的明文
C-&gt;B: 发送修改后的密文
Note over B: 使用\n私钥 B 解密\n修改后的密文
Note over B: 执行错误操作
</code></pre><p><strong>真实案例</strong></p><blockquote><p>南京90后小伙从网上学来了一种小技巧，只花1分钱就能成功充值上百元话费，结果因涉嫌盗窃罪被警方批捕。</p><p>据央视新闻报道，小伙无业，在一个“薅羊毛”的聊天群里，于是“先是用1分钱充了200元成功到账，然后就开始反复充值，一共到账58笔、26000余元。”</p><p>除了这名90后小伙，聊天群的其他数十位网友，仅仅两天就通过这个攻略，“薅”走了160多万元话费。</p><p>经调查，江苏某电子商务公司的网上话费充值平台由于没有设置校验环节，导致支付环节存在技术漏洞，从而被黑客利用。</p><p>日前，小刘等人因涉嫌盗窃罪，被南京市检雨花台区检察院正式批捕。</p></blockquote><p>这就是中间人攻击。</p><ul><li>原先<ul><li>甲通过平台充值 200 元话费，平台会根据甲提供的支付手段（银行卡/支付宝/微信钱包）扣除 200 元。</li></ul></li><li>中间人攻击<ul><li>乙先通过平台充值 200 元话费，然后截取平台发送给支付方的消息，修改金额为 0.01 元。</li><li>并且平台没有设置校验环节。<ul><li>我给用户充值了 200 元，但是我有没有扣除用户 200 元呢？</li></ul></li></ul></li></ul><h3 id="解决方法">解决方法</h3><p>中间人攻击的关键在哪儿？<br /> 在于<strong>客户端</strong>无法分辨<strong>服务器</strong>和<strong>中间人</strong>。</p><ul><li><strong>服务器</strong>说“我是服务器”。</li><li><strong>中间人</strong>也说“我是服务器”。</li></ul><p>最终<strong>客户端</strong>使用了<strong>中间人</strong>的公钥来加密明文，使得明文被中间人<strong>修改</strong>了。</p><p>在现实生活中，如何分辨一个人呢？</p><ul><li>要求他出示身份证，用机器扫描这张身份证是不是真的。</li><li>再人脸识别这个人和身份证是否匹配。</li></ul><p>在网络中，也有类似于身份证的东西——<strong>证书</strong>。</p><ul><li>最正规，最值得信赖的证书是由 <strong>CA（数字证书颁发机构）</strong> 颁发的。<ul><li>这是最权威的，在互联网类似于国家背书的身份证一样。</li></ul></li><li>技术能力强的程序员可以<strong>自己实现</strong>证书。<ul><li>这个证书就没什么可信度了，类似于街头的小公司。<ul><li>有的小公司虽然小，但是是个正经公司。</li><li>有的是皮包公司。</li><li>有的是传销组织。</li><li>……</li></ul></li></ul></li></ul><p>对于一般用户来说，他们不需要担心自己的电脑（即客户端）合不合法，他们只担心访问的网站（服务器）合不合法。<br /> 客户端发出请求后，服务器会在响应报文中放入自己的<strong>数字证书</strong>，以便客户端检查得到的消息是否是正确的。<br /> 各类浏览器都会实现对于证书的解析，有问题的会进行如下提示：<br /> <img src="\images\posts\encryption\asymmetric\unsafe.png" alt="image" /><br /> 这就是证书有问题的网站：<strong>它无法证明它是自己</strong>。<br /> 尽量不要使用此类网站，如果一定要使用，请注意：</p><ul><li>谨慎填写任何有用的信息，包括但不限于<ul><li>个人信息</li><li>任何账号密码</li></ul></li><li>谨慎进行任何金钱操作。</li></ul><h4 id="具体实现">具体实现</h4><p>我们已经知道了非对称加密和解决方法，接下来看一看具体实现。</p><p>通过仔细观察中间人攻击的流程，我们可以发现两个关键点：</p><ol><li>中间人把服务器的公钥换成了自己的。</li><li>中间人修改了明文。</li></ol><p>所以要防御中间人攻击，我们必须解决这两点。</p><ol><li>数字证书</li><li>数字签名</li></ol><h5 id="数字证书">数字证书</h5><p>数字证书中到底有什么呢？<br /> 数字证书中存储了网站的各种相关信息（包括域名）。<br /> 最重要的是，它存储了网站的<strong>公钥</strong>。</p><p>原本，我们通过网络直接传递公钥。<br /> 但现在，我们通过数字证书传递公钥。</p><ol><li>服务器通过提交<strong>各类信息</strong>和自己的<strong>公钥</strong>向专业机构申请证书。</li><li>专业机构在验证信息后，会形成证书。<br /> <strong>并且将证书使用自己的私钥加密（机构也有属于自己的密钥对）</strong>。</li><li>专业机构将加密后的证书交给服务器，服务器之后发送响应报文时会带上这张证书。</li><li>客户端（浏览器）有一个<strong>证书管理器</strong>，其中有<strong>受信任的根证书颁发机构</strong>列表。<br /> 客户端收到响应报文后，会在列表中寻找能解开数字证书的<strong>公钥</strong>。<br /> 一般而言，会发生以下两种安全问题：<ul><li>证书的颁发机构不受信任。<br /> <img src="\images\posts\encryption\asymmetric\not-trusted.jpeg" alt="image" /></li><li>证书的内容被修改了。<br /> <img src="\images\posts\encryption\asymmetric\be-modified.png" alt="image" /></li></ul></li><li>如果证书没问题，则客户端使用证书中记载的<strong>服务器的公钥</strong>解开报文。</li></ol><h5 id="数字签名">数字签名</h5><p>数字签名又称为<strong>摘要</strong>。</p><p>为了防止正文不被修改，我们往往采用<strong>数字签名</strong>（又称为<strong>摘要</strong>）的方式。</p><ul><li>将整篇正文做 Hash 运算，得到一个散列值（一般是 128 位）。</li><li>使用<strong>发送方的私钥</strong>将签名加密，附在正文后一起发送。</li><li>接收方收到数据后，先使用<strong>发送方的公钥</strong>将正文和签名都解开。</li><li>接收方再做一遍 Hash 运算，把结果和收到的签名进行比对。<ul><li>一致：说明正文没有发生修改。</li><li>不一致：说明正文被修改了。</li></ul></li></ul><p>这种方法是很难破解的：</p><ul><li>不同的内容很难有一样的散列值。<br /> <code class="language-plaintext highlighter-rouge">我是张三1</code>和<code class="language-plaintext highlighter-rouge">我是张三2</code>的散列值完全不一样。</li><li>即使散列值相同了，修改后的内容大概也是一团糟。<br /><ul><li><code class="language-plaintext highlighter-rouge">我是张三。</code><br /> <code class="language-plaintext highlighter-rouge">好的，你是张三。</code></li><li><code class="language-plaintext highlighter-rouge">$#^^*(**(&amp;^%$#%@#%*&amp;(*)))</code><br /> <code class="language-plaintext highlighter-rouge">不好意思，我听不懂。</code></li><li>此时接收方是无法识别的。</li></ul></li><li>数字证书就采用了数字签名的方式保证自身的正确性。<ul><li>用机构的私钥加密。</li><li>用机构的公钥解密。</li></ul></li><li>很多网站在传递数据时也会使用数字签名。</li></ul><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://kekaiyuan.github.io/" target="_blank">Kaiyuan Ke</a></li><li>本文链接：<a href="https://kekaiyuan.github.io//2021/09/08/asymmetric/" target="_blank">https://kekaiyuan.github.io//2021/09/08/asymmetric/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/09/08/asymmetric/', clientID: '', clientSecret: '', repo: '', owner: '', admin: [''], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:350px" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:16px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://kekaiyuan.github.io//assets/search_data.json?v=1646200240', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="Kaiyuan Ke">Kaiyuan Ke</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/kekaiyuan/kekaiyuan.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://kekaiyuan.github.io//" title="首页" target="">首页</a></li><li> <a href="https://kekaiyuan.github.io//categories/" title="分类" target="">分类</a></li><li> <a href="https://kekaiyuan.github.io//archives/" title="归档" target="">归档</a></li><li> <a href="https://kekaiyuan.github.io//wiki/" title="维基" target="">维基</a></li><li> <a href="https://kekaiyuan.github.io//links/" title="链接" target="">链接</a></li><li> <a href="https://kekaiyuan.github.io//about/" title="关于" target="">关于</a></li><li><a href="https://kekaiyuan.github.io//feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script> {\% if page.mermaid \%} <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/7.1.0/mermaid.min.js"></script> <script> var config = { startOnLoad:true, flowchart:{ useMaxWidth:false, htmlLabels:true } }; mermaid.initialize(config); $(function(){ var elements = document.getElementsByClassName("language-mermaid"); for (var i = elements.length; i--;) { element = elements[i]; var graphDefinition = element.innerText; if (graphDefinition) { var svg = mermaid.render('ha_mermaid_' + i, graphDefinition, function(svg){}); if (svg) { var svgElement = document.createElement('div'); preNode = element.parentNode; svgElement.innerHTML = svg; svgElement.setAttribute('class', 'mermaid'); svgElement.setAttribute('data-processed', 'true'); preNode.parentNode.replaceChild(svgElement, preNode); } } } }); </script> {\% endif \%} <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/webfont.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/snap.svg-min.js"></script> <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.1/underscore-umd-min.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/js-sequence-diagrams/dist/sequence-diagram-min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/js-sequence-diagrams/dist/sequence-diagram-min.css"> <script> $(".language-sequence").sequenceDiagram({theme: 'simple'}); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
