<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Java Spring 05—— AOP 的高级应用 &mdash; 菜鸟日记</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://kekaiyuan.github.io//2021/08/02/05-transaction/"><link rel="alternate" type="application/atom+xml" title="菜鸟日记" href="https://kekaiyuan.github.io//feed.xml"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/favicon.ico"><meta property="og:title" content="Java Spring 05—— AOP 的高级应用"><meta name="keywords" content="Java, Spring"><meta name="og:keywords" content="Java, Spring"><meta name="description" content="Java Spring 05—— AOP 的高级应用"><meta name="og:description" content="Java Spring 05—— AOP 的高级应用"><meta property="og:url" content="https://kekaiyuan.github.io//2021/08/02/05-transaction/"><meta property="og:site_name" content="菜鸟日记"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-08-02"> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://kekaiyuan.github.io//" title="菜鸟日记"><span class="octicon octicon-mark-github"></span> 菜鸟日记</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://kekaiyuan.github.io//" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="https://kekaiyuan.github.io//categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="https://kekaiyuan.github.io//archives/" class=" site-header-nav-item" target="" title="归档">归档</a> <a href="https://kekaiyuan.github.io//wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="https://kekaiyuan.github.io//links/" class=" site-header-nav-item" target="" title="链接">链接</a> <a href="https://kekaiyuan.github.io//about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Java Spring 05—"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Java Spring 05—— AOP 的高级应用</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/08/02 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://kekaiyuan.github.io//categories/#Spring" title="Spring">Spring</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 26391 字，约 76 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"> <img style="height:72px;width:72px" src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/images/qrcode.jpg" alt="闷骚的程序员" /></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>Java Spring 05—— AOP 的高级应用</p><h1 id="spring-jdbctemplate">Spring JdbcTemplate</h1><p>在 Spring 中为了更加方便的操作 JDBC，在 JDBC 的基础之上定义了一个抽象层。<br /> 此设计的目的是为不同类型的 JDBC 操作提供模板方法，每个模板方法都能控制整个过程，并允许覆盖过程中的特定任务。<br /> 通过这种方式，可以尽可能保留灵活性，将数据库存取的工作量讲到最低。</p><h2 id="环境配置">环境配置</h2><p>添加 pom 依赖</p><p>pom.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>com.mashibing<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring_demo<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.2.3.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>druid<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.1.21<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.47<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/cglib/cglib --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>cglib<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cglib<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.3.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.aspectj<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>aspectjweaver<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.9.5<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/aopalliance/aopalliance --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>aopalliance<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>aopalliance<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-aspects --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-aspects<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.2.3.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><hr /><p>编写数据库连接的配置文件</p><p>dbconfig.properties</p><div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">jdbc.username</span><span class="p">=</span><span class="s">root123</span>
<span class="py">password</span><span class="p">=</span><span class="s">123456</span>
<span class="py">url</span><span class="p">=</span><span class="s">jdbc:mysql://localhost:3306/demo</span>
<span class="py">driverClassName</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
</code></pre></div></div><hr /><p>通过 xml 文件导入 dataSource 对象</p><p>applicationContext.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/aop
       https://www.springframework.org/schema/aop/spring-aop.xsd
"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:dbconfig.properties"</span><span class="nt">&gt;&lt;/context:property-placeholder&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.alibaba.druid.pool.DruidDataSource"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"${jdbc.driverClassName}"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><hr /><p>测试</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"jdbcTemplate.xml"</span><span class="o">);</span>
<span class="nc">DruidDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"dataSource"</span><span class="o">,</span> <span class="nc">DruidDataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div><p>结果</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">com</span><span class="o">.</span><span class="na">mysql</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">JDBC4Connection</span><span class="err">@</span><span class="mi">611889</span><span class="n">f4</span>
</code></pre></div></div><p>成功地使用 druid 与 mysql 建立了连接。</p><h2 id="添加-jdbctemplate-对象">添加 JdbcTemplate 对象</h2><p>添加 pom 依赖</p><p>pom.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-orm --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-orm<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>5.2.3.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><hr /><p>在 xml 文件中添加 JdbcTemplate 对象</p><p>applicationContext.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:dbconfig.properties"</span><span class="nt">&gt;&lt;/context:property-placeholder&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.alibaba.druid.pool.DruidDataSource"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>
	<span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"${jdbc.driverClassName}"</span><span class="nt">&gt;&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jdbcTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.core.JdbcTemplate"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
...
</code></pre></div></div><p>在创建 JdbcTemplate 对象必须传入一个 dataSource 对象。</p><hr /><p>测试</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"jdbcTemplate"</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">jdbcTemplate</span><span class="o">);</span>
</code></pre></div></div><p>结果</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">jdbc</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">JdbcTemplate</span><span class="err">@</span><span class="mi">37858383</span>
</code></pre></div></div><p>成功创建了 JdbcTemplate 对象</p><h2 id="使用-jdbctemplate-对象读写数据">使用 JdbcTemplate 对象读写数据</h2><p>使用 JdbcTemplate 对象读写数据非常地方便。<br /> 我们只需要定义 sql 语句即可，其他细节 Spring 会帮我们自动完成。</p><h3 id="插入单条数据">插入单条数据</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"jdbcTemplate"</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into emp(empno,ename) values(?,?)"</span><span class="o">;</span>
<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="mi">1111</span><span class="o">,</span> <span class="s">"zhangsan"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</code></pre></div></div><p>是不是很方便，只需要写 sql 语句，然后直接调用 JdbcTemplate 的方法执行 sql 语句即可。</p><h3 id="插入批量数据">插入批量数据</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"jdbcTemplate"</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into emp(empno,ename) values(?,?)"</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">[]&gt;();</span>
<span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="mi">1</span><span class="o">,</span><span class="s">"zhangsan1"</span><span class="o">});</span>
<span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="mi">2</span><span class="o">,</span><span class="s">"zhangsan2"</span><span class="o">});</span>
<span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="mi">3</span><span class="o">,</span><span class="s">"zhangsan3"</span><span class="o">});</span>
<span class="kt">int</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">batchUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">:</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><h3 id="查询单个对象">查询单个对象</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"jdbcTemplate"</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from emp where empno = ?"</span><span class="o">;</span>
<span class="nc">Emp</span> <span class="n">emp</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BeanPropertyRowMapper</span><span class="o">&lt;&gt;(</span><span class="nc">Emp</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="mi">7369</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">emp</span><span class="o">);</span>
</code></pre></div></div><p>注：Emp 是与数据表 emp 对应的实体类。</p><h3 id="查询多个对象">查询多个对象</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"jdbcTemplate"</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select * from emp where sal &gt; ?"</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Emp</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="nc">BeanPropertyRowMapper</span><span class="o">&lt;&gt;(</span><span class="nc">Emp</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="mi">1500</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">Emp</span> <span class="n">emp</span> <span class="o">:</span> <span class="n">query</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">emp</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><h3 id="执行组合函数">执行组合函数</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"jdbcTemplate"</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select max(sal) from emp"</span><span class="o">;</span>
<span class="nc">Double</span> <span class="n">aDouble</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="nc">Double</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">aDouble</span><span class="o">);</span>
</code></pre></div></div><h5 id="8使用具备具名函数的jdbctemplate">8、使用具备具名函数的JdbcTemplate</h5><p>jdbcTemplate.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/aop
       https://www.springframework.org/schema/aop/spring-aop.xsd
"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:dbconfig.properties"</span><span class="nt">&gt;&lt;/context:property-placeholder&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.alibaba.druid.pool.DruidDataSource"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"${jdbc.driverClassName}"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jdbcTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.core.JdbcTemplate"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"namedParameterJdbcTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>MyTest.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"applicationContext.xml"</span><span class="o">);</span>
<span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"jdbcTemplate"</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"jdbcTemplate.xml"</span><span class="o">);</span>
        <span class="nc">NamedParameterJdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"namedParameterJdbcTemplate"</span><span class="o">,</span> <span class="nc">NamedParameterJdbcTemplate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into emp(empno,ename) values(:empno,:ename)"</span><span class="o">;</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"empno"</span><span class="o">,</span><span class="mi">2222</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"ename"</span><span class="o">,</span><span class="s">"sili"</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">map</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h5 id="9整合empdao">9、整合EmpDao</h5><p>jdbcTemplate.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.mashibing"</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>
</code></pre></div></div><p>EmpDao.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.mashibing.bean.Emp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmpDao</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Emp</span> <span class="n">emp</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into emp(empno,ename) values(?,?)"</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">emp</span><span class="o">.</span><span class="na">getEmpno</span><span class="o">(),</span> <span class="n">emp</span><span class="o">.</span><span class="na">getEname</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">update</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>MyTest.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.mashibing.bean.Emp</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.mashibing.dao.EmpDao</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.sql.SQLException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SQLException</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"jdbcTemplate.xml"</span><span class="o">);</span>
        <span class="nc">EmpDao</span> <span class="n">empDao</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"empDao"</span><span class="o">,</span> <span class="nc">EmpDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">empDao</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Emp</span><span class="o">(</span><span class="mi">3333</span><span class="o">,</span><span class="s">"wangwu"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h1 id="声明式事务">声明式事务</h1><p>现有某 service 类 ，调用某 dao ，执行了一系列 SQL 操作，此时如何为其添加事务支持？</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ADao</span> <span class="n">aDao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">aMethod</span><span class="o">(...){</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">select</span><span class="o">(...);</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">(...);</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">insert</span><span class="o">(...);</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">delete</span><span class="o">(...);</span>
		<span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>总结：在事务控制方面，主要有两个分类：</p><p>编程式事务：在代码中直接加入处理事务的逻辑，可能需要在代码中显式调用beginTransaction()、commit()、rollback()等事务管理相关的方法</p><p>声明式事务：在方法的外部添加注解或者直接在配置文件中定义，将事务管理代码从业务方法中分离出来，以声明的方式来实现事务管理。spring的AOP恰好可以完成此功能：事务管理代码的固定模式作为一种横切关注点，通过AOP方法模块化，进而实现声明式事务。</p><h5 id="2声明式事务的简单配置">2、声明式事务的简单配置</h5><p>Spring从不同的事务管理API中抽象出了一整套事务管理机制，让事务管理代码从特定的事务技术中独立出来。开发人员通过配置的方式进行事务管理，而不必了解其底层是如何实现的。</p><p>Spring的核心事务管理抽象是PlatformTransactionManager。它为事务管理封装了一组独立于技术的方法。无论使用Spring的哪种事务管理策略(编程式或声明式)，事务管理器都是必须的。</p><p>事务管理器可以以普通的bean的形式声明在Spring IOC容器中。下图是spring提供的事务管理器 <img src="..\image\事务管理器.png" alt="事务管理器" /></p><p>1、在配置文件中添加事务管理器</p><p>jdbcTemplate.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/aop
       https://www.springframework.org/schema/aop/spring-aop.xsd
       http://www.springframework.org/schema/tx
       https://www.springframework.org/schema/tx/spring-tx.xsd
"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.mashibing"</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>
    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:dbconfig.properties"</span><span class="nt">&gt;&lt;/context:property-placeholder&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.alibaba.druid.pool.DruidDataSource"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"${jdbc.driverClassName}"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jdbcTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.core.JdbcTemplate"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="c">&lt;!--事务控制--&gt;</span>
    <span class="c">&lt;!--配置事务管理器的bean--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="c">&lt;!--开启基于注解的事务控制模式，依赖tx名称空间--&gt;</span>
    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;&lt;/tx:annotation-driven&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>添加注解</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ADao</span> <span class="n">aDao</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">aMethod</span><span class="o">(...){</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">select</span><span class="o">(...);</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">(...);</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">insert</span><span class="o">(...);</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">delete</span><span class="o">(...);</span>
		<span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h1 id="配置事务属性">配置事务属性</h1><p><a href="https://kekaiyuan.github.io//2021/07/02/transaction/#%E4%BA%8B%E5%8A%A1">事务详解</a></p><h2 id="传播特性">传播特性</h2><p>当某个事务<strong>调用</strong>了另一个事务，此时它们之间的关系是怎样的？<br /> 传播特性就是用于处理这个的。</p><table><thead><tr><th style="text-align: center">传播属性</th><th style="text-align: left">描述</th></tr></thead><tbody><tr><td style="text-align: center">REQUIRED</td><td style="text-align: left">如果有事务在运行，当前的方法就在这个事务内运行，否则，就启动一个新的事务，并在自己的事务内运行</td></tr><tr><td style="text-align: center">REQUIRES_NEW</td><td style="text-align: left"> </td></tr><tr><td style="text-align: center">SUPPORTS</td><td style="text-align: left"> </td></tr><tr><td style="text-align: center">NOT_SUPPORTED</td><td style="text-align: left"> </td></tr><tr><td style="text-align: center">MANDATORY</td><td style="text-align: left"> </td></tr><tr><td style="text-align: center">NEVER</td><td style="text-align: left"> </td></tr><tr><td style="text-align: center">NESTED</td><td style="text-align: left"> </td></tr></tbody></table><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ADao</span> <span class="n">aDao</span><span class="o">;</span>

	<span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">XXX</span><span class="o">,</span> <span class="n">rollbackFor</span> <span class="o">=</span> <span class="o">{</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">methodA</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
    <span class="o">}</span>
	
	<span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">XXX</span><span class="o">,</span> <span class="n">rollbackFor</span> <span class="o">=</span> <span class="o">{</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">methodB</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MulService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">AService</span> <span class="n">aService</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mul</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">aService</span><span class="o">.</span><span class="na">methodA</span><span class="o">();</span>
        <span class="n">aService</span><span class="o">.</span><span class="na">methodB</span><span class="o">();</span>
    <span class="o">}</span>
	
<span class="o">}</span>
</code></pre></div></div><p>有异常都回滚</p><p>REQUIRES_NEW</p><h3 id="详解-required-requires_new-nested">详解 REQUIRED, REQUIRES_NEW, NESTED</h3><p>这三个传播特性的描述很类似，它们具体有什么不同呢？</p><hr /><p>情况一</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">ADao</span> <span class="n">aDao</span><span class="o">;</span>

	<span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">,</span> <span class="n">rollbackFor</span> <span class="o">=</span> <span class="o">{</span><span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">methodA</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">();</span>
    <span class="o">}</span>
	
	<span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">methodB</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
		<span class="n">aDao</span><span class="o">.</span><span class="na">update</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MulService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">AService</span> <span class="n">aService</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mul</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">try</span><span class="o">{</span>
			<span class="n">aService</span><span class="o">.</span><span class="na">methodA</span><span class="o">();</span>
		<span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span>
        <span class="n">aService</span><span class="o">.</span><span class="na">methodB</span><span class="o">();</span>
    <span class="o">}</span>
	
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">methodA()</code> 抛出的异常被<strong>捕获</strong>了，<code class="language-plaintext highlighter-rouge">methodB()</code> 会回滚吗？<br /> <strong>会</strong>！<br /> 如果 <code class="language-plaintext highlighter-rouge">methodA()</code> 的传播级别为 <strong>REQUIRES_NEW</strong> 和 <strong>NESTED</strong>，<code class="language-plaintext highlighter-rouge">methodB()</code> <strong>不会回滚</strong>！</p><hr /><h2 id="隔离级别">隔离级别</h2><p>可设置事务的 <a href="https://kekaiyuan.github.io//2021/07/02/transaction/#%E9%9A%94%E7%A6%BB%E6%80%A7-isolation">隔离级别</a></p><p>使用所连接数据库<strong>默认</strong>的隔离级别</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">)</span>
</code></pre></div></div><p>读未提交</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">READ_UNCOMMITTED</span><span class="o">)</span>
</code></pre></div></div><p>读已提交</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">READ_COMMITTED</span><span class="o">)</span>
</code></pre></div></div><p>可重复读</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">REPEATABLE_READ</span><span class="o">)</span>
</code></pre></div></div><p>序列化</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">isolation</span> <span class="o">=</span> <span class="nc">Isolation</span><span class="o">.</span><span class="na">SERIALIZABLE</span><span class="o">)</span>
</code></pre></div></div><h2 id="设置超时">设置超时</h2><p>可通过设置 <code class="language-plaintext highlighter-rouge">timeout</code> 属性来设置超时，单位为<strong>秒</strong>。<br /> 当事务执行时间<strong>超时</strong>后，将自动<strong>终止</strong>该事务并<strong>回滚</strong>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">3</span><span class="o">)</span>
</code></pre></div></div><p>如果该事务执行时间超过 <strong>3s</strong>，<strong>自动失败并回滚</strong>。</p><h2 id="只读事务">只读事务</h2><p>可通过设置 <code class="language-plaintext highlighter-rouge">readonly</code> 属性来设置是否是只读事务，<strong>默认否</strong>。</p><ul><li>执行一条查询语句<br /> 不需要开启事务，数据库默认支持 SQL 执行期间的读一致性。</li><li>执行多条查询语句<br /> 此时必须开启事务，保证整体的读一致性。<br /></li></ul><p>当事务内只有<strong>读</strong>操作时，可设置该事务为只读事务。<br /> 此时数据库将<strong>阻止</strong>其他事务修改数据。<br /> 并且因为是只读事务，不存在数据修改，数据库会提供一些优化手段来<strong>加快</strong>读取速度。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</code></pre></div></div><h2 id="异常处理">异常处理</h2><p>当<strong>事务</strong>执行过程中发生异常时，<strong>默认</strong>情况下</p><ul><li>RunTimeExpcetion 及其子类会自动回滚</li><li>其他异常不会自动回滚</li></ul><p>除此之外，我们可以手动配置处理异常时的回滚问题</p><ul><li>声明哪些异常<strong>不需要回滚</strong><ul><li><code class="language-plaintext highlighter-rouge">noRollbackFor</code><br /> 填写 class 对象，使用 {}<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">noRollbackFor</span> <span class="o">=</span> <span class="o">{</span><span class="nc">FileNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</code></pre></div></div></li><li><code class="language-plaintext highlighter-rouge">noRollbackForClassName</code><br /> 填写完整类名，使用 “”<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">noRollbackForClassName</span> <span class="o">=</span> <span class="s">"java.io.FileNotFoundException"</span><span class="o">)</span>
</code></pre></div></div></li></ul></li><li>声明哪些异常<strong>需要回滚</strong><ul><li><code class="language-plaintext highlighter-rouge">rollbackFor</code><br /> 填写 class 对象，使用 {}<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="o">{</span><span class="nc">FileNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</code></pre></div></div></li><li><code class="language-plaintext highlighter-rouge">rollbackForClassName</code><br /> 填写完整类名，使用 “”<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackForClassName</span> <span class="o">=</span> <span class="s">"java.io.FileNotFoundException"</span><span class="o">)</span>
</code></pre></div></div></li></ul></li></ul><h5 id="9事务的传播特性">9、事务的传播特性</h5><p>事务的传播特性指的是当一个事务方法被另一个事务方法调用时，这个事务方法应该如何进行？</p><p>spring的事务传播行为一共有7种：</p><p><img src="..\..\spring\image\传播特性.jpg" alt="传播特性" /></p><h5 id="10测试事务的传播特性">10、测试事务的传播特性</h5><p>BookDao.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.dao</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span><span class="nd">@Repositorypublic</span> <span class="kd">class</span> <span class="nc">BookDao</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>    <span class="cm">/**     * 减去某个用户的余额     * @param userName     * @param price     */</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateBalance</span><span class="o">(</span><span class="nc">String</span> <span class="n">userName</span><span class="o">,</span><span class="kt">int</span> <span class="n">price</span><span class="o">){</span>        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"update account set balance=balance-? where username=?"</span><span class="o">;</span>        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span><span class="n">price</span><span class="o">,</span><span class="n">userName</span><span class="o">);</span>    <span class="o">}</span>    <span class="cm">/**     * 按照图书的id来获取图书的价格     * @param id     * @return     */</span>    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getPrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"select price from book where id=?"</span><span class="o">;</span>        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span><span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">id</span><span class="o">);</span>    <span class="o">}</span>    <span class="cm">/**     * 减库存，减去某本书的库存     * @param id     */</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateStock</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">){</span>        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"update book_stock set stock=stock-1 where id=?"</span><span class="o">;</span>        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span><span class="n">id</span><span class="o">);</span>    <span class="o">}</span>    <span class="cm">/**     * 修改图书价格     * @param id     * @param price     */</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span><span class="kt">int</span> <span class="n">price</span><span class="o">){</span>        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"update book set price=? where id =?"</span><span class="o">;</span>        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span><span class="n">price</span><span class="o">,</span><span class="n">id</span><span class="o">);</span>    <span class="o">}}</span>
</code></pre></div></div><p>BookService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Isolation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Propagation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="nc">BookDao</span> <span class="n">bookDao</span><span class="o">;</span>    <span class="cm">/**     * 结账：传入哪个用户买了哪本书     * @param username     * @param id     */</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkout</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateStock</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">price</span> <span class="o">=</span> <span class="n">bookDao</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateBalance</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span><span class="kt">int</span> <span class="n">price</span><span class="o">){</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>    <span class="o">}}</span>
</code></pre></div></div><p>MulService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">MulService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="kd">private</span> <span class="nc">BookService</span> <span class="n">bookService</span><span class="o">;</span>    <span class="nd">@Transactional</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mulTx</span><span class="o">(){</span>        <span class="n">bookService</span><span class="o">.</span><span class="na">checkout</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>        <span class="n">bookService</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1000</span><span class="o">);</span>    <span class="o">}}</span>
</code></pre></div></div><p>MyTest.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.mashibing.service.MulService</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="o">;</span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTest</span> <span class="o">{</span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>        <span class="nc">ApplicationContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"jdbcTemplate.xml"</span><span class="o">);</span>        <span class="nc">MulService</span> <span class="n">mulService</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"mulService"</span><span class="o">,</span> <span class="nc">MulService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>        <span class="n">mulService</span><span class="o">.</span><span class="na">mulTx</span><span class="o">();</span>    <span class="o">}}</span>
</code></pre></div></div><p>通过上图的结果发现，如果设置的传播特性是Required，那么所有的事务都会统一成一个事务，一旦发生错误，所有的数据都要进行回滚。</p><hr /><p>BookService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">com.mashibing.dao.BookDao</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Isolation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Propagation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="nc">BookDao</span> <span class="n">bookDao</span><span class="o">;</span>    <span class="cm">/**     * 结账：传入哪个用户买了哪本书     * @param username     * @param id     */</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkout</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateStock</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">price</span> <span class="o">=</span> <span class="n">bookDao</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateBalance</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span><span class="kt">int</span> <span class="n">price</span><span class="o">){</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>    <span class="o">}}</span>
</code></pre></div></div><p>通过修改checkout方法的传播特性为Required_new,发现价格进行了回滚，而其他的数据没有进行回滚。</p><hr /><p>BookService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">com.mashibing.dao.BookDao</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Isolation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Propagation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="nc">BookDao</span> <span class="n">bookDao</span><span class="o">;</span>    <span class="cm">/**     * 结账：传入哪个用户买了哪本书     * @param username     * @param id     */</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkout</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateStock</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">price</span> <span class="o">=</span> <span class="n">bookDao</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateBalance</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span><span class="kt">int</span> <span class="n">price</span><span class="o">){</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}}</span>
</code></pre></div></div><p>MulService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span><span class="kn">import</span> <span class="nn">com.mashibing.bean.Book</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">MulService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="kd">private</span> <span class="nc">BookService</span> <span class="n">bookService</span><span class="o">;</span>    <span class="nd">@Transactional</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mulTx</span><span class="o">(){</span>        <span class="n">bookService</span><span class="o">.</span><span class="na">checkout</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>        <span class="n">bookService</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1000</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>    <span class="o">}}</span>
</code></pre></div></div><p>将bookservice方法的传播行为为Required，并且将报错设置在MulService中，发现会都进行回滚。</p><hr /><p>BookService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">com.mashibing.dao.BookDao</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Isolation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Propagation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="nc">BookDao</span> <span class="n">bookDao</span><span class="o">;</span>    <span class="cm">/**     * 结账：传入哪个用户买了哪本书     * @param username     * @param id     */</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkout</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateStock</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">price</span> <span class="o">=</span> <span class="n">bookDao</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateBalance</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span><span class="kt">int</span> <span class="n">price</span><span class="o">){</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}}</span>
</code></pre></div></div><p>MulService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span><span class="kn">import</span> <span class="nn">com.mashibing.bean.Book</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span><span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">MulService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="kd">private</span> <span class="nc">BookService</span> <span class="n">bookService</span><span class="o">;</span>    <span class="nd">@Transactional</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mulTx</span><span class="o">(){</span>        <span class="n">bookService</span><span class="o">.</span><span class="na">checkout</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>        <span class="n">bookService</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1000</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>    <span class="o">}}</span>
</code></pre></div></div><p>将bookservice方法的传播行为为Requires_new，并且将报错设置在MulService中，发现都不会进行回滚。</p><hr /><p>BookService.java</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mashibing.service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">com.mashibing.dao.BookDao</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Isolation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Propagation</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>        <span class="kn">import</span> <span class="nn">java.io.FileNotFoundException</span><span class="o">;</span><span class="nd">@Servicepublic</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>    <span class="nd">@Autowired</span>    <span class="nc">BookDao</span> <span class="n">bookDao</span><span class="o">;</span>    <span class="cm">/**     * 结账：传入哪个用户买了哪本书     * @param username     * @param id     */</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkout</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateStock</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">price</span> <span class="o">=</span> <span class="n">bookDao</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updateBalance</span><span class="o">(</span><span class="n">username</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}</span>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updatePrice</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span><span class="kt">int</span> <span class="n">price</span><span class="o">){</span>        <span class="n">bookDao</span><span class="o">.</span><span class="na">updatePrice</span><span class="o">(</span><span class="n">id</span><span class="o">,</span><span class="n">price</span><span class="o">);</span>    <span class="o">}</span>    <span class="nd">@Transactional</span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mulTx</span><span class="o">(){</span>        <span class="n">checkout</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span>        <span class="n">updatePrice</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1000</span><span class="o">);</span>        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>    <span class="o">}}</span>
</code></pre></div></div><p>如果在bookservice执行的话，会发现刚刚的效果就没有了，原因是外层调用的时候使用的AOP，但是本类方法自己的调用就是最最普通的调用，就是同一个事务。</p><p>总结：</p><div class="language-tex highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1、事务传播级别是REQUIRED，当checkout()被调用时（假定被另一类中commit()调用），如果checkout()中的代码抛出异常，即便被捕获，commit()中的其他代码都会roll back2、是REQUIRES<span class="p">_</span>NEW，如果checkout()中的代码抛出异常，并且被捕获，commit()中的其他代码不会roll back；如果commit()中的其他代码抛出异常，而且没有捕获，不会导致checkout()回滚3、是NESTED，如果checkout()中的代码抛出异常，并且被捕获，commit()中的其他代码不会roll back；如果commit()中的其他代码抛出异常，而且没有捕获，会导致checkout()回滚    PROPAGATION<span class="p">_</span>REQUIRES<span class="p">_</span>NEW 启动一个新的, 不依赖于环境的 "内部" 事务. 这个事务将被完全 commited 或 rolled back 而不依赖于外部事务, 它拥有自己的隔离范围, 自己的锁, 等等. 当内部事务开始执行时, 外部事务将被挂起, 内务事务结束时, 外部事务将继续执行.     另一方面, PROPAGATION<span class="p">_</span>NESTED 开始一个 "嵌套的" 事务,  它是已经存在事务的一个真正的子事务. 嵌套事务开始执行时,  它将取得一个 savepoint. 如果这个嵌套事务失败, 我们将回滚到此 savepoint. 潜套事务是外部事务的一部分, 只有外部事务结束后它才会被提交.     由此可见, PROPAGATION<span class="p">_</span>REQUIRES<span class="p">_</span>NEW 和 PROPAGATION<span class="p">_</span>NESTED 的最大区别在于, PROPAGATION<span class="p">_</span>REQUIRES<span class="p">_</span>NEW 完全是一个新的事务, 而 PROPAGATION<span class="p">_</span>NESTED 则是外部事务的子事务, 如果外部事务 commit, 嵌套事务也会被 commit, 这个规则同样适用于 roll back. 
</code></pre></div></div><h3 id="3基于xml的事务配置">3、基于xml的事务配置</h3><p>jdbcTemplate.xml</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans       http://www.springframework.org/schema/beans/spring-beans.xsd       http://www.springframework.org/schema/context       http://www.springframework.org/schema/context/spring-context.xsd       http://www.springframework.org/schema/aop       https://www.springframework.org/schema/aop/spring-aop.xsd       http://www.springframework.org/schema/tx       https://www.springframework.org/schema/tx/spring-tx.xsd"</span><span class="nt">&gt;</span>    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.mashibing"</span><span class="nt">&gt;&lt;/context:component-scan&gt;</span>    <span class="nt">&lt;context:property-placeholder</span> <span class="na">location=</span><span class="s">"classpath:dbconfig.properties"</span><span class="nt">&gt;&lt;/context:property-placeholder&gt;</span>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.alibaba.druid.pool.DruidDataSource"</span><span class="nt">&gt;</span>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">&gt;&lt;/property&gt;</span>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">&gt;&lt;/property&gt;</span>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">&gt;&lt;/property&gt;</span>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"${jdbc.driverClassName}"</span><span class="nt">&gt;&lt;/property&gt;</span>    <span class="nt">&lt;/bean&gt;</span>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jdbcTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.core.JdbcTemplate"</span><span class="nt">&gt;</span>        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>    <span class="nt">&lt;/bean&gt;</span>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"namedParameterJdbcTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate"</span><span class="nt">&gt;</span>        <span class="nt">&lt;constructor-arg</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>    <span class="nt">&lt;/bean&gt;</span>    <span class="c">&lt;!--事务控制--&gt;</span>    <span class="c">&lt;!--配置事务管理器的bean--&gt;</span>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span><span class="nt">&gt;&lt;/property&gt;</span>    <span class="nt">&lt;/bean&gt;</span>    <span class="c">&lt;!--    基于xml配置的事务：依赖tx名称空间和aop名称空间        1、spring中提供事务管理器（切面），配置这个事务管理器        2、配置出事务方法        3、告诉spring哪些方法是事务方法（事务切面按照我们的切入点表达式去切入事务方法）    --&gt;</span>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"bookService"</span> <span class="na">class=</span><span class="s">"com.mashibing.service.BookService"</span><span class="nt">&gt;&lt;/bean&gt;</span>    <span class="nt">&lt;aop:config&gt;</span>        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"txPoint"</span> <span class="na">expression=</span><span class="s">"execution(* com.mashibing.service.*.*(..))"</span><span class="nt">/&gt;</span>        <span class="c">&lt;!--事务建议：advice-ref:指向事务管理器的配置--&gt;</span>        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"myAdvice"</span> <span class="na">pointcut-ref=</span><span class="s">"txPoint"</span><span class="nt">&gt;&lt;/aop:advisor&gt;</span>    <span class="nt">&lt;/aop:config&gt;</span>    <span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"myAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>        <span class="c">&lt;!--事务属性--&gt;</span>        <span class="nt">&lt;tx:attributes&gt;</span>            <span class="c">&lt;!--指明哪些方法是事务方法--&gt;</span>            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"*"</span><span class="nt">/&gt;</span>            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"checkout"</span> <span class="na">propagation=</span><span class="s">"REQUIRED"</span><span class="nt">/&gt;</span>            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"get*"</span> <span class="na">read-only=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/tx:method&gt;</span>        <span class="nt">&lt;/tx:attributes&gt;</span>    <span class="nt">&lt;/tx:advice&gt;&lt;/beans&gt;</span>
</code></pre></div></div><h1 id="源码链接">源码链接</h1><p>该文章源码链接 <a href="url">Github</a></p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://kekaiyuan.github.io/" target="_blank">Kaiyuan Ke</a></li><li>本文链接：<a href="https://kekaiyuan.github.io//2021/08/02/05-transaction/" target="_blank">https://kekaiyuan.github.io//2021/08/02/05-transaction/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/vendor/gitalk/gitalk.css"> <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> <script> var gitalk = new Gitalk({ id: '/2021/08/02/05-transaction/', clientID: '', clientSecret: '', repo: '', owner: '', admin: [''], labels: ['gitment'], perPage: 50, }); gitalk.render('gitalk-container'); </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:350px" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:16px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://kekaiyuan.github.io//assets/search_data.json?v=1646200239', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2015 <span title="Kaiyuan Ke">Kaiyuan Ke</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/kekaiyuan/kekaiyuan.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://kekaiyuan.github.io//" title="首页" target="">首页</a></li><li> <a href="https://kekaiyuan.github.io//categories/" title="分类" target="">分类</a></li><li> <a href="https://kekaiyuan.github.io//archives/" title="归档" target="">归档</a></li><li> <a href="https://kekaiyuan.github.io//wiki/" title="维基" target="">维基</a></li><li> <a href="https://kekaiyuan.github.io//links/" title="链接" target="">链接</a></li><li> <a href="https://kekaiyuan.github.io//about/" title="关于" target="">关于</a></li><li><a href="https://kekaiyuan.github.io//feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/kekaiyuan/kekaiyuan.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
